--[[
OVERDOORS â€” Full single-file (final)
Features:
- WalkSpeed = 14
- Sprint loader (safe)
- Force spawn 2 Guiding flashlights (duplicate)
- Flashlight reacts to entities
- Block all 'seek' music
- Captions (startup, room1, room2), intro image
- Random entity scheduler
- Guiding light at room 45
- Startup sound id = 115302709211847
- Hurt sound id = 85494350890427
- Safe: guarded flags, pcall protection
by chu be te liet (merged & fixed)
]]

if getgenv().OVERDOORS_FULL_LOADED then
	print("[OVERDOORS] already loaded")
	return
end
getgenv().OVERDOORS_FULL_LOADED = true

-- ================== SERVICES ==================
local Players = game:GetService("Players")
local RS = game:GetService("ReplicatedStorage")
local Debris = game:GetService("Debris")
local Workspace = game:GetService("Workspace")
local ContentProvider = game:GetService("ContentProvider")
local SoundService = game:GetService("SoundService")
local RunService = game:GetService("RunService")

local LocalPlayer = Players.LocalPlayer

-- safe helpers
local function safe(f, ...) local ok, a = pcall(f, ...) if not ok then return false, a end return true, a end
local function log(...) print("[OVERDOORS]", ...) end

-- ================== STARTUP + HURT SOUNDS (non-conflicting) ==================
do
	if getgenv().OD_SOUNDS_LOADED then
		-- already inited
	else
		getgenv().OD_SOUNDS_LOADED = true

		-- CONFIG (user-specified IDs)
		local STARTUP_SOUND_ID = "rbxassetid://115302709211847"
		local STARTUP_VOLUME = 1
		local HURT_SOUND_ID = "rbxassetid://85494350890427"
		local HURT_VOLUME = 1.0
		local HURT_COOLDOWN = 0.6

		-- helper to create sound
		local function makeSound(name, soundId, volume, parent)
			local s = Instance.new("Sound")
			s.Name = name
			s.SoundId = soundId or ""
			s.Volume = volume or 1
			s.Looped = false
			s.PlaybackSpeed = 1
			s.Parent = parent or SoundService
			pcall(function() s:Stop() end)
			return s
		end

		local cam = Workspace.CurrentCamera or Workspace

		-- create startup sound
		local startupSound
		pcall(function()
			startupSound = makeSound("OD_STARTUP_SND", STARTUP_SOUND_ID, STARTUP_VOLUME, cam)
			pcall(function() ContentProvider:PreloadAsync({startupSound}) end)
		end)

		if startupSound then
			task.spawn(function()
				task.wait(0.06)
				pcall(function()
					if not startupSound.Playing then
						startupSound.TimePosition = 0
						startupSound:Play()
					end
				end)
				local con
				con = startupSound.Ended:Connect(function()
					if con then pcall(function() con:Disconnect() end) end
					pcall(function() if startupSound and startupSound.Parent then startupSound:Destroy() end end)
				end)
				task.delay(120, function() pcall(function() if startupSound and startupSound.Parent then startupSound:Destroy() end end) end)
			end)
		else
			warn("[OVERDOORS] startup sound failed to init")
		end

		-- hurt sound instance
		local hurtSound
		pcall(function()
			hurtSound = makeSound("OD_HURT_SND", HURT_SOUND_ID, HURT_VOLUME, cam)
			pcall(function() ContentProvider:PreloadAsync({hurtSound}) end)
		end)

		local lastHurtAt = 0
		local function playHurtSound()
			if not hurtSound then return end
			local now = tick()
			if now - lastHurtAt < HURT_COOLDOWN then return end
			lastHurtAt = now
			pcall(function()
				if hurtSound.Playing then pcall(function() hurtSound:Stop() end) end
				hurtSound.TimePosition = 0
				hurtSound:Play()
			end)
		end

		local function connectHumanoid(hum)
			if not hum or not hum:IsA("Humanoid") then return end
			local lastHealth = hum.Health
			local conn
			conn = hum.HealthChanged:Connect(function(newHealth)
				if type(newHealth) ~= "number" then return end
				if newHealth < lastHealth then
					pcall(playHurtSound)
				end
				lastHealth = newHealth
			end)
			hum.AncestryChanged:Connect(function(_, parent)
				if not parent and conn then pcall(function() conn:Disconnect() end) end
			end)
		end

		-- attach existing character humanoid
		if LocalPlayer and LocalPlayer.Character then
			local hum = LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
			if hum then connectHumanoid(hum) end
		end
		-- on spawn
		if LocalPlayer then
			LocalPlayer.CharacterAdded:Connect(function(char)
				local hum = char:WaitForChild("Humanoid", 3) or char:FindFirstChildOfClass("Humanoid")
				if hum then
					task.wait(0.06)
					connectHumanoid(hum)
				end
			end)
		end

		Workspace:GetPropertyChangedSignal("CurrentCamera"):Connect(function()
			task.defer(function()
				cam = Workspace.CurrentCamera or Workspace
				if startupSound and startupSound.Parent ~= cam then pcall(function() startupSound.Parent = cam end) end
				if hurtSound and hurtSound.Parent ~= cam then pcall(function() hurtSound.Parent = cam end) end
			end)
		end)

		function OD_PlayStartupSound() pcall(function() if startupSound and not startupSound.Playing then startupSound.TimePosition = 0; startupSound:Play() end end) end
		function OD_PlayHurtSound() pcall(playHurtSound) end
		log("OD sounds initialized (startup & hurt):", STARTUP_SOUND_ID, HURT_SOUND_ID)
	end
end

-- ================== CAPTION (MainGame.caption) ==================
task.spawn(function()
	local tries = 0
	repeat
		task.wait(0.5)
		tries = tries + 1
		if tries > 30 then break end
	until (LocalPlayer and LocalPlayer:FindFirstChild("PlayerGui") and LocalPlayer.PlayerGui:FindFirstChild("MainUI")
	and LocalPlayer.PlayerGui.MainUI:FindFirstChild("Initiator") and LocalPlayer.PlayerGui.MainUI.Initiator:FindFirstChild("Main_Game"))

	local MainGame
	if LocalPlayer and LocalPlayer:FindFirstChild("PlayerGui") and LocalPlayer.PlayerGui:FindFirstChild("MainUI")
		and LocalPlayer.PlayerGui.MainUI:FindFirstChild("Initiator") and LocalPlayer.PlayerGui.MainUI.Initiator:FindFirstChild("Main_Game") then
		local ok, mod = pcall(function() return require(LocalPlayer.PlayerGui.MainUI.Initiator.Main_Game) end)
		if ok and mod and type(mod.caption) == "function" then MainGame = mod end
	end

	if MainGame then
		pcall(function() MainGame.caption("OVERDOORS BY CHÃš BÃ‰ TÃŠ LIá»†T,", true) end)
	else
		task.spawn(function()
			task.wait(0.4)
			if LocalPlayer and LocalPlayer:FindFirstChild("PlayerGui") then
				safe(function()
					local g = Instance.new("ScreenGui", LocalPlayer.PlayerGui); g.ResetOnSpawn = false; g.Name = "OD_CAP_FALLBACK"
					local l = Instance.new("TextLabel", g)
					l.Size = UDim2.fromScale(1,0.08); l.Position = UDim2.fromScale(0,0.45)
					l.BackgroundTransparency = 1; l.TextScaled = true; l.Font = Enum.Font.GothamBold
					l.Text = "OVERDOORS BY CHÃš BÃ‰ TÃŠ LIá»†T,"; Debris:AddItem(g,6)
				end)
			end
		end)
	end

	-- room1 caption
	if workspace:FindFirstChild("CurrentRooms") then
		workspace.CurrentRooms.ChildAdded:Connect(function(room)
			local rn = tonumber(room.Name)
			if rn == 1 then
				task.wait(0.2)
				if MainGame then
					pcall(function() MainGame.caption("good luck ðŸ‘ðŸ—¿", true) end)
				else
					if LocalPlayer and LocalPlayer:FindFirstChild("PlayerGui") then
						pcall(function()
							local g = Instance.new("ScreenGui", LocalPlayer.PlayerGui); g.ResetOnSpawn=false; g.Name="OD_CAP_ROOM1"
							local l = Instance.new("TextLabel", g)
							l.Size = UDim2.fromScale(1,0.06); l.Position = UDim2.fromScale(0,0.88)
							l.BackgroundTransparency = 1; l.TextScaled=true; l.Font=Enum.Font.GothamBold
							l.TextColor3 = Color3.fromRGB(170,255,200); l.Text = "good luck ðŸ‘ðŸ—¿"
							Debris:AddItem(g,6)
						end)
					end
				end
			end
		end)
	end
end)

-- ================== INTRO IMAGE ==================
task.spawn(function()
	task.wait(0.6)
	if not LocalPlayer or not LocalPlayer:FindFirstChild("PlayerGui") then return end
	local gui = Instance.new("ScreenGui", LocalPlayer.PlayerGui); gui.Name = "OD_INTRO_IMAGE"; gui.ResetOnSpawn = false
	local img = Instance.new("ImageLabel", gui)
	img.Size = UDim2.fromScale(1,1); img.BackgroundTransparency = 1; img.ScaleType = Enum.ScaleType.Fit
	img.Image = "rbxassetid://93664194964832"; img.ImageTransparency = 1
	for i=1,12 do img.ImageTransparency = img.ImageTransparency - 0.08; task.wait(0.03) end
	task.wait(1.6)
	for i=1,12 do img.ImageTransparency = img.ImageTransparency + 0.08; task.wait(0.03) end
	gui:Destroy()
end)

-- ================== WALK SPEED = 14 (stable) ==================
local DEFAULT_WALKSPEED = 14
local function applyWalkSpeed(char)
	if not char then return end
	local humanoid = char:FindFirstChildOfClass("Humanoid")
	if humanoid then
		pcall(function() humanoid.WalkSpeed = DEFAULT_WALKSPEED end)
	end
end
if LocalPlayer and LocalPlayer.Character then applyWalkSpeed(LocalPlayer.Character) end
Players.PlayerAdded:Connect(function(plr) if plr == LocalPlayer then plr.CharacterAdded:Connect(function(c) task.wait(0.06); applyWalkSpeed(c) end) end end)
if LocalPlayer then LocalPlayer.CharacterAdded:Connect(function(c) task.wait(0.06); applyWalkSpeed(c) end) end

-- ================== SPRINT LOADER (safe) ==================
do
	local SPRINT_URL = "https://raw.githubusercontent.com/Junbbinopro/Sprint-stamina-v3/refs/heads/main/Sprint"
	if getgenv().OVERDOORS_SPRINT_LOADED then
		log("Sprint script already loaded (flag).")
	else
		getgenv().OVERDOORS_SPRINT_LOADED = true
		task.spawn(function()
			local ok, err = pcall(function()
				local code = game:HttpGet(SPRINT_URL, true)
				if code and #code > 8 then
					local fn = loadstring(code)
					if fn then pcall(fn); log("Sprint script loaded (attempted).") else log("Sprint loadstring failed") end
				else
					log("Sprint fetch returned empty/short body or failed")
				end
			end)
			if not ok then log("Sprint loader error:", err) end
		end)
	end
end

-- ================== ENTITIES LIST ==================
local ENTITY_URLS = {
	"https://raw.githubusercontent.com/Junbbinopro/Depth-entity/refs/heads/main/Depth",
	"https://raw.githubusercontent.com/Junbbinopro/Guardian-entity/refs/heads/main/Guardian",
	"https://raw.githubusercontent.com/Junbbinopro/Wh1t3/refs/heads/main/Entity",
	"https://raw.githubusercontent.com/trungdepth-dot/Entity-greance/refs/heads/main/Greance-20",
	"https://raw.githubusercontent.com/binhlforsaken156-sys/Hauntstep-entity/refs/heads/main/OVERDOORS%20HAUNTSTEP%20ENTYTY.lua",
	"https://raw.githubusercontent.com/Zeca130/doors-my-version-nightmareMode./refs/heads/main/Entity6",
	"https://raw.githubusercontent.com/Idk-lol2/a-60aa/refs/heads/main/---======%20a-60%20agresiv%20spawner%20======---.txt",
	"https://github.com/PABMAXICHAC/doors-monsters-scripts/raw/main/blinkcrux"
}
local function safeLoadRemote(url)
	if not url or url == "" then return false, "no url" end
	local ok, body = pcall(function() return game:HttpGet(url, true) end)
	if not ok or not body or #body < 8 then return false, "fetch failed" end
	body = body:gsub("(%d%d%d%d%d+)", "1")
	local fn, err = loadstring(body)
	if not fn then return false, ("loadstring err: %s"):format(tostring(err)) end
	local suc, rerr = pcall(fn)
	if not suc then return false, ("runtime err: %s"):format(tostring(rerr)) end
	return true
end

-- ================== RANDOM ROOM SCHEDULER ==================
task.spawn(function()
	while not (RS:FindFirstChild("GameData") and RS.GameData:FindFirstChild("LatestRoom")) do task.wait(0.4) end
	local LatestRoom = RS.GameData.LatestRoom
	local lastRoom = LatestRoom.Value or 0
	local function scheduleNext(fromRoom) return (fromRoom or lastRoom) + math.random(3,7) end
	getgenv().OVERDOORS_nextEntityRoom = getgenv().OVERDOORS_nextEntityRoom or scheduleNext(lastRoom)
	local nextSpawn = getgenv().OVERDOORS_nextEntityRoom
	local busy = false

	LatestRoom.Changed:Connect(function()
		local cur = LatestRoom.Value or 0
		if cur <= lastRoom then lastRoom = cur; return end
		lastRoom = cur
		if cur == nextSpawn then
			if not busy then
				busy = true
				task.spawn(function()
					local found = false
					for _,m in ipairs(Workspace:GetChildren()) do
						if m:IsA("Model") then
							local n = tostring(m.Name):lower()
							if n:find("repentance") or n:find("seek") or n:find("ambush") or n:find("rush") then found = true; break end
						end
					end
					if not found then
						local url = ENTITY_URLS[math.random(#ENTITY_URLS)]
						local ok, err = safeLoadRemote(url)
						if ok then log("spawned entity from", url) else log("spawn failed:", err) end
					else
						log("entity present, skip spawn")
					end
					task.wait(2)
					busy = false
				end)
			end
			nextSpawn = scheduleNext(cur)
			getgenv().OVERDOORS_nextEntityRoom = nextSpawn
			log("next entity scheduled at room", nextSpawn)
		end
	end)
end)

-- ================== GIVE GUIDING FLASHLIGHT: FORCE DUPLICATE ==================
do
	local FLASH_TOOL_ASSET = "rbxassetid://79481104952584"
	local FLASH_SCRIPT_URL = "https://raw.githubusercontent.com/binhlforsaken156-sys/Guiding-flash-light/refs/heads/main/Guiding-flash-light.lua"
	local TRY_DELAY = 0.06

	if getgenv().GUIDING_FLASH_FORCED_DUPED then
		log("Guiding flash forced-dupe already ran")
	else
		getgenv().GUIDING_FLASH_FORCED_DUPED = true

		local function isFlashTool(inst)
			if not inst or not inst:IsA("Tool") then return false end
			local n = tostring(inst.Name or ""):lower()
			local pats = {"flash","guid","purple","gummy","torch","light"}
			for _,p in ipairs(pats) do if n:find(p) then return true end end
			return false
		end

		local function getFlashTools()
			local out = {}
			if LocalPlayer then
				if LocalPlayer:FindFirstChild("Backpack") then
					for _,v in ipairs(LocalPlayer.Backpack:GetChildren()) do if isFlashTool(v) then table.insert(out, v) end end
				end
				if LocalPlayer.Character then
					for _,v in ipairs(LocalPlayer.Character:GetChildren()) do if isFlashTool(v) then table.insert(out, v) end end
				end
			end
			return out
		end

		local function spawnOneToolFromAsset()
			if not LocalPlayer then return false, "no_localplayer" end
			local ok, inst = pcall(function() return game:GetObjects(FLASH_TOOL_ASSET)[1] end)
			if not ok or not inst then return false, "getobjects_failed" end
			pcall(function()
				local bp = LocalPlayer:FindFirstChild("Backpack") or LocalPlayer
				inst.Parent = bp
			end)
			task.wait(TRY_DELAY)
			return true, inst
		end

		local function ensureTwo()
			if not LocalPlayer then return false, "no_localplayer" end
			local tools = getFlashTools()
			if #tools >= 2 then
				log("Already have", #tools, "flash tools; skipping spawn")
				return true, "already_two_or_more"
			end

			if #tools == 0 then
				local ok, instOrErr = spawnOneToolFromAsset()
				if not ok then log("spawnOne failed:", instOrErr) else log("spawned tool (1):", (instOrErr and instOrErr.Name) or "<unknown>") end
				task.wait(0.12)
			end

			tools = getFlashTools()
			if #tools >= 2 then return true, "done" end

			if #tools == 1 then
				local existing = tools[1]
				local ok, clone = pcall(function() return existing:Clone() end)
				if ok and clone then
					pcall(function() clone.Parent = LocalPlayer:FindFirstChild("Backpack") or LocalPlayer end)
					task.wait(0.08)
					log("cloned second tool from existing one")
				else
					local ok2, inst2 = spawnOneToolFromAsset()
					if ok2 then log("spawned second tool via asset") else log("failed spawn second:", inst2) end
				end
			else
				local ok1, i1 = spawnOneToolFromAsset()
				task.wait(0.08)
				local ok2, i2 = spawnOneToolFromAsset()
				if ok1 or ok2 then log("attempted to spawn two tools via asset") end
			end

			task.wait(0.12)
			tools = getFlashTools()
			log("final flash tool count:", #tools)
			return (#tools >= 1), (#tools >= 2) and "two_ok" or ("only_" .. tostring(#tools))
		end

		local function tryLoadGuidingScript()
			if not FLASH_SCRIPT_URL then return false end
			local ok, err = pcall(function() return loadstring(game:HttpGet(FLASH_SCRIPT_URL, true))() end)
			if ok then log("Guiding script loaded") return true end
			log("Guiding script load failed:", err)
			return false
		end

		task.spawn(function()
			for i = 1, 3 do
				local ok, why = ensureTwo()
				log("GUIDE DUPER attempt", i, ok, why)
				if ok and (why == "two_ok" or why == "already_two_or_more") then break end
				task.wait(0.25)
			end
			pcall(tryLoadGuidingScript)
		end)

		if LocalPlayer then
			LocalPlayer.Backpack.ChildAdded:Connect(function(child)
				task.defer(function() task.wait(0.08); log("Backpack.ChildAdded -> maybe flash tool added") end)
			end)
		end
	end
end

-- ================== FLASHLIGHT REACTION TO ENTITY ==================
do
	local function affectFlashlight()
		local char = LocalPlayer and LocalPlayer.Character
		if not char then return end
		local tool = char:FindFirstChildOfClass("Tool") or (LocalPlayer:FindFirstChild("Backpack") and LocalPlayer.Backpack:FindFirstChildOfClass("Tool"))
		if not tool then return end
		local handle = tool:FindFirstChild("Handle")
		if not handle then return end
		local light = handle:FindFirstChildWhichIsA("PointLight") or handle:FindFirstChildWhichIsA("SurfaceLight")
		if not light then return end
		local old = light.Brightness
		pcall(function() light.Brightness = math.max(0, old * 0.35) end)
		task.delay(1.2, function() if light and light.Parent then pcall(function() light.Brightness = old end) end end)
	end

	Workspace.ChildAdded:Connect(function(obj)
		if not obj or not obj:IsA("Model") then return end
		local name = tostring(obj.Name or ""):lower()
		if name:find("seek") or name:find("rush") or name:find("ambush") or name:find("repentance") or name:find("a60") then
			task.delay(0.06, function() pcall(affectFlashlight) end)
		end
	end)
end

-- ================== REMOVE / BLOCK ALL SEEK MUSIC ==================
do
	local function isSeekSound(s)
		if not s or not s:IsA("Sound") then return false end
		local n = tostring(s.Name or ""):lower()
		if n:find("seek") or n:find("kiddo") or n:find("c00lkidd") then return true end
		local sid = tostring(s.SoundId or ""):lower()
		if sid:find("seek") then return true end
		return false
	end

	for _,v in ipairs(Workspace:GetDescendants()) do
		if isSeekSound(v) then pcall(function() v:Stop() end); pcall(function() v:Destroy() end) end
	end
	for _,v in ipairs(SoundService:GetDescendants()) do
		if isSeekSound(v) then pcall(function() v:Stop() end); pcall(function() v:Destroy() end) end
	end

	Workspace.DescendantAdded:Connect(function(v)
		if isSeekSound(v) then
			task.defer(function() task.wait(0.02); pcall(function() v:Stop() end); pcall(function() v:Destroy() end) end)
		end
	end)
	SoundService.DescendantAdded:Connect(function(v)
		if isSeekSound(v) then
			task.defer(function() task.wait(0.02); pcall(function() v:Stop() end); pcall(function() v:Destroy() end) end)
		end
	end)

	log("Seek music disabled (existing + future blocked)")
end

-- ================== GUIDING LIGHT (ROOM 45) ==================
task.spawn(function()
	while not (RS:FindFirstChild("GameData") and RS.GameData:FindFirstChild("LatestRoom")) do task.wait(0.5) end
	local LatestRoom = RS.GameData.LatestRoom
	local triggered = false
	LatestRoom.Changed:Connect(function()
		if triggered then return end
		if LatestRoom.Value == 45 then
			triggered = true
			task.spawn(function()
				if not LocalPlayer or not LocalPlayer:FindFirstChild("PlayerGui") then return end
				local g = Instance.new("ScreenGui", LocalPlayer.PlayerGui); g.Name="GUIDING_ROOM_45"; g.ResetOnSpawn=false
				local t = Instance.new("TextLabel", g)
				t.Size = UDim2.fromScale(1,0.16); t.Position = UDim2.fromScale(0,0.42)
				t.BackgroundTransparency = 1; t.TextScaled=true; t.Font = Enum.Font.GothamBold
				t.TextColor3 = Color3.fromRGB(0,210,255); t.TextStrokeTransparency = 0.6
				t.Text = "Do you really trust me?"
				Debris:AddItem(g, 2)
			end)
			log("Guiding Light triggered at room 45")
		end
	end)
end)

-- ================== ROOM2: caption ONLY ==================
task.spawn(function()
	while not (RS:FindFirstChild("GameData") and RS.GameData:FindFirstChild("LatestRoom")) do task.wait(0.3) end
	local LatestRoom = RS.GameData.LatestRoom
	local MainGame
	local tries = 0
	repeat
		task.wait(0.4); tries = tries + 1
		if LocalPlayer and LocalPlayer:FindFirstChild("PlayerGui") and LocalPlayer.PlayerGui:FindFirstChild("MainUI")
			and LocalPlayer.PlayerGui.MainUI:FindFirstChild("Initiator") and LocalPlayer.PlayerGui.MainUI.Initiator:FindFirstChild("Main_Game") then
			local ok,mod = pcall(function() return require(LocalPlayer.PlayerGui.MainUI.Initiator.Main_Game) end)
			if ok and mod and type(mod.caption) == "function" then MainGame = mod; break end
		end
	until tries >= 30

	LatestRoom.Changed:Connect(function(v)
		local rn = tonumber(v) or tonumber(LatestRoom.Value) or nil
		if rn == 2 then
			log("Entered room 2 -> caption (intro music removed)")
			if MainGame then
				pcall(function() MainGame.caption("loaded successfully", true) end)
			else
				if LocalPlayer and LocalPlayer:FindFirstChild("PlayerGui") then
					pcall(function()
						local g = Instance.new("ScreenGui", LocalPlayer.PlayerGui); g.ResetOnSpawn=false; g.Name="OD_LOADED_CAP"
						local lbl = Instance.new("TextLabel", g)
						lbl.Size = UDim2.fromScale(1,0.06); lbl.Position = UDim2.fromScale(0,0.88)
						lbl.BackgroundTransparency = 1; lbl.TextScaled=true; lbl.Font=Enum.Font.GothamBold
						lbl.TextColor3 = Color3.fromRGB(170,255,200); lbl.Text = "loaded successfully"
						Debris:AddItem(g,3)
					end)
				end
			end
		end
	end)
end)

-- ================== READY ==================
log("âœ… OVERDOORS FULL LOADED â€” WalkSpeed=14 applied, sprint loader attempted, flash dupe + flashlight reaction active, seek music blocked, sounds ready")
